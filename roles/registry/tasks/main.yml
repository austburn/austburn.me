---
- name: create cert directory
  file: path=/home/austin/certs state=directory

- name: copy certs
  command: cp /etc/letsencrypt/live/{{ domain }}/{{ item }} /home/austin/certs
  with_items:
    - fullchain.pem
    - privkey.pem

- name: install htpasswd
  apt: name=apache2-utils state=present

- name: htpasswd
  command: htpasswd -bBc /home/austin/htpasswd {{ docker_user }} {{ docker_password }}

- name: setup input rules iptables
  iptables: chain=INPUT destination_port=443 protocol=tcp jump=ACCEPT

- name: start registry
  docker_container:
    name: registry
    image: registry:2
    state: started
    restart: yes
    restart_policy: always
    volumes:
      - /home/austin/certs:/certs
      - /home/austin/htpasswd:/auth/htpasswd
    published_ports:
      - "{{ ansible_eth0.ipv4.address }}:443:5000"
    env:
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/fullchain.pem
      REGISTRY_HTTP_TLS_KEY: /certs/privkey.pem
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
