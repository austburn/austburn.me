user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    upstream flask {
        server 127.0.0.1:5050;
    }

    server {
        listen {{ ansible_eth0.ipv4.address }}:80;
        server_name {{ domain }};
        return 301 https://$server_name$request_uri;
    }

    server {
        listen {{ ansible_eth0.ipv4.address }}:443 ssl;
        server_name {{ domain }};

        ssl_certificate     /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;
        ssl_prefer_server_ciphers On;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

        location / {
            proxy_pass http://flask;
        }

        # deny access to files
        location ~ /\. {
            deny all;
        }
    }
}
